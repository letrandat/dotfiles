# ============================================================================
# Prefix Configuration
# ============================================================================
# Alternative prefix: Alt+Space
set -g prefix2 M-Space           # Secondary prefix: Alt+Space
bind M-Space send-prefix -2      # Allow Alt+Space Alt+Space to send literal Alt+Space

# ============================================================================
# General Settings
# ============================================================================
set -g allow-passthrough on          # OSC 9/777 passthrough for notifications
set -g base-index 1                  # Start windows from 1
setw -g pane-base-index 1            # Start panes from 1

# ============================================================================
# Notification & Attention System
# ============================================================================
set -g bell-action any
set -g visual-bell off
set -g focus-events on
set-hook -g pane-focus-in "set-option -w @attention 0"

# ============================================================================
# Status Bar
# ============================================================================
set -g status-left ""
set -g status-right "#S"
set -g status-right-length 100

# Red background when @attention=1
set -g window-status-format "#{?#{==:#{@attention},1},#[fg=black bg=red bold] [#I#{?#{e|>:#{window_panes},1},:#{pane_index},} #W]! #[default], [#I#{?#{e|>:#{window_panes},1},:#{pane_index},} #W]#F }"
set -g window-status-current-format "#[fg=black,bg=cyan,bold] [#I#{?#{e|>:#{window_panes},1},:#{pane_index},} #W] #[default]"


# Copy mode with vi bindings
setw -g mode-keys vi

# Automatically renumber windows when one is closed
set -g renumber-windows on

# Enable mouse support for scrolling and pane management
set -g mouse on
bind -n MouseDown1Status select-window -t=
# Double-click on the window name in the status bar to rename it
bind -n DoubleClick1Status command-prompt -I "#W" "rename-window '%%'"

# ============================================================================
# Copy Mode Configuration
# ============================================================================
# Enter copy mode with 'prefix v'
bind-key v copy-mode

# Copy mode vi bindings
bind-key -T copy-mode-vi v send -X begin-selection
# Remap Y to copy to end of line to clipboard
bind-key -T copy-mode-vi Y send-keys -X begin-selection \; send-keys -X end-of-line \; send-keys -X copy-pipe-and-cancel "pbcopy"
# Copy to clipboard
bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "pbcopy"

# Smart PageUp: Enter copy-mode-vi if not in an alternate screen app (like Vim)
bind-key -n PageUp if-shell -F "#{alternate_on}" "send-keys PageUp" "copy-mode -u"

# ============================================================================
# Pane Management ("Buffer" metaphor)
# ============================================================================
# Close pane: prefix b d
bind b switch-client -T buffer-menu
bind -T buffer-menu d kill-pane

# Split panes: prefix w v (vertical), prefix w s (horizontal)
bind w switch-client -T window-menu
bind -T window-menu v split-window -h -c "#{pane_current_path}"
bind -T window-menu s split-window -v -c "#{pane_current_path}"
bind -T window-menu d kill-pane

# Vim-style navigation (h/l for Windows)
bind h previous-window
bind l next-window

# Pick panes/buffers: prefix ,
bind , choose-tree -Z

# ============================================================================
# Window Management (Browser style)
# ============================================================================
# New window: prefix t
bind t new-window -c "#{pane_current_path}"

# Close window: prefix x (with confirmation)
bind x confirm-before -p "kill window #W? (y/n)" kill-window

# Search/switch windows in current session: prefix a
bind a choose-window

# Rename window: prefix r
bind r command-prompt -I "#W" "rename-window '%%'"

# Reload configuration: prefix R
bind R source-file ~/.tmux.conf \; display-message "Tmux config loaded!"

# ============================================================================
# Help Menu (Which-key style)
# ============================================================================
# Show help menu: prefix ?
bind ? display-menu -T "#[align=centre]Tmux Keybindings" \
  "Window Menu (w)" w "display-menu -T 'Window Menu' 'Split Vertical' v 'split-window -h' 'Split Horizontal' s 'split-window -v' 'Kill Pane' d 'kill-pane'" \
  "Buffer Menu (b)" b "display-menu -T 'Buffer Menu' 'Kill Pane' d 'kill-pane'" \
  "" \
  "New Window" t "new-window -c '#{pane_current_path}'" \
  "Kill Window" x "confirm-before -p 'kill window #W? (y/n)' kill-window" \
  "Rename Window" r "command-prompt -I '#W' 'rename-window %%'" \
  "Previous Window" h "previous-window" \
  "Next Window" l "next-window" \
  "Choose Window" a "choose-window" \
  "" \
  "Copy Mode" v "copy-mode" \
  "Choose Pane/Buffer" , "choose-tree -Z" \
  "" \
  "Reload Config" R "source-file ~/.tmux.conf"

# ============================================================================
# 2-Pane Workspace: Claude-Primary Model
# ============================================================================
# Left pane (1): Claude Code - primary AI workspace
# Right pane (2): Neovim - quick verification/edits
#
# Usage:
# - Start: Claude in pane 1, zoomed
# - Cmd+L (via Ghostty): Toggle to pane 2 (zooms if exists, creates unzoomed if missing)
# - Cmd+L: Toggle back to pane 1 (zooms)
#
# Edge cases:
# - Pane 2 missing: auto-creates right split with same cwd (stays unzoomed to show both)
# - 3+ panes: ignores extras, toggles between 1 and 2
# - Cross-window: applies to any window (creates pane 2 if needed)
# ============================================================================

# Pane toggle: prefix L (triggered by Ghostty Cmd+L)
# Toggles between pane 1 (Claude) and pane 2 (Neovim) with zoom
# Uses select-pane -Z for atomic select+zoom to avoid flash
bind L run-shell ' \
  if [ "#{pane_index}" = "1" ]; then \
    if ! tmux select-pane -t :.2 -Z 2>/dev/null; then \
      tmux split-window -h -c "#{pane_current_path}"; \
    fi; \
  else \
    tmux select-pane -t :.1 -Z; \
  fi \
'
