#!/usr/bin/env node

const fs = require('fs');
const path = require('path');

// Source: Windsurf workflows (already synced from openskills)
const WINDSURF_WORKFLOWS_DIR = path.join(process.env.HOME, 'workspace/dotfiles/codeium/.codeium/windsurf/global_workflows');
const WINDSURF_RULES_DIR = path.join(process.env.HOME, 'workspace/dotfiles/.windsurf/rules');

// Target: Antigravity workflows
const ANTIGRAVITY_WORKFLOWS_DIR = path.join(process.env.HOME, 'workspace/dotfiles/.agent/workflows');
const GEMINI_RULES_DIR = path.join(process.env.HOME, 'workspace/dotfiles/gemini/.gemini/rules');

function convertToAntigravityFormat(content) {
  // Windsurf uses auto_execution_mode: 0, Antigravity doesn't need it
  // Remove auto_execution_mode from frontmatter
  return content.replace(/^(---\n[\s\S]*?)auto_execution_mode:\s*\d+\n([\s\S]*?---)/m, '$1$2');
}

function syncWorkflows() {
  console.log('üîÑ Syncing Windsurf ‚Üí Antigravity workflows...\n');

  if (!fs.existsSync(WINDSURF_WORKFLOWS_DIR)) {
    console.error(`‚ùå Windsurf workflows not found: ${WINDSURF_WORKFLOWS_DIR}`);
    console.log('   Run "openskills-to-windsurf sync" first.');
    process.exit(1);
  }

  if (!fs.existsSync(ANTIGRAVITY_WORKFLOWS_DIR)) {
    fs.mkdirSync(ANTIGRAVITY_WORKFLOWS_DIR, { recursive: true });
  }

  const files = fs.readdirSync(WINDSURF_WORKFLOWS_DIR)
    .filter(f => f.endsWith('.md'));

  let synced = 0;
  let skipped = 0;

  for (const file of files) {
    const srcPath = path.join(WINDSURF_WORKFLOWS_DIR, file);
    const dstPath = path.join(ANTIGRAVITY_WORKFLOWS_DIR, file);

    try {
      const content = fs.readFileSync(srcPath, 'utf8');
      const converted = convertToAntigravityFormat(content);
      fs.writeFileSync(dstPath, converted, 'utf8');
      console.log(`‚úÖ ${file}`);
      synced++;
    } catch (error) {
      console.error(`‚ùå ${file}: ${error.message}`);
      skipped++;
    }
  }

  return { synced, skipped };
}

function syncRules() {
  console.log('\nüîÑ Syncing Windsurf ‚Üí Gemini rules...\n');

  if (!fs.existsSync(WINDSURF_RULES_DIR)) {
    console.log('‚ö†Ô∏è  No Windsurf rules found, skipping.');
    return { synced: 0, skipped: 0 };
  }

  if (!fs.existsSync(GEMINI_RULES_DIR)) {
    fs.mkdirSync(GEMINI_RULES_DIR, { recursive: true });
  }

  const files = fs.readdirSync(WINDSURF_RULES_DIR)
    .filter(f => f.endsWith('.md'));

  let synced = 0;
  let skipped = 0;

  for (const file of files) {
    const srcPath = path.join(WINDSURF_RULES_DIR, file);
    const dstPath = path.join(GEMINI_RULES_DIR, file);

    try {
      fs.copyFileSync(srcPath, dstPath);
      console.log(`‚úÖ ${file}`);
      synced++;
    } catch (error) {
      console.error(`‚ùå ${file}: ${error.message}`);
      skipped++;
    }
  }

  return { synced, skipped };
}

function runSync() {
  const workflows = syncWorkflows();
  const rules = syncRules();

  console.log('\nüìä Summary:');
  console.log(`   Workflows: ${workflows.synced} synced, ${workflows.skipped} skipped`);
  console.log(`   Rules: ${rules.synced} synced, ${rules.skipped} skipped`);
  console.log(`\nüìÅ Workflows: ${ANTIGRAVITY_WORKFLOWS_DIR}`);
  console.log(`üìÅ Rules: ${GEMINI_RULES_DIR}`);
}

// CLI
const args = process.argv.slice(2);
const command = args[0];

if (command === 'sync') {
  runSync();
} else {
  console.log('Usage: openskills-to-antigravity sync');
  console.log('\nSyncs Windsurf workflows to Antigravity.');
  console.log('\nFlow: openskills ‚Üí Windsurf ‚Üí Antigravity');
  process.exit(1);
}
