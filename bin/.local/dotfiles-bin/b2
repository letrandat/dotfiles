#!/usr/bin/env bash
# b2 - Beads wrapper with stealth mode, hash expansion, and auto-setup
# Usage: b2 [bd-commands...]
#
# Features:
# - Stealth mode by default (--no-stealth to enable git sync)
# - Short hash expansion (8jk → dotfiles-8jk)
# - Shared beads location (~/.local/share/b2)
# - Auto-install bd if missing
# - Auto-setup on first run
# - Update checking (24hr cache)

set -euo pipefail

# Version
B2_VERSION="0.1.0"

# Default configuration (overridden by config files and env vars)
BEADS_LOCATION="${B2_BEADS_LOCATION:-${HOME}/.local/share/b2}"
STEALTH_MODE="${B2_STEALTH_MODE:-true}"
CHECK_UPDATES="${B2_CHECK_UPDATES:-true}"
UPDATE_CHECK_INTERVAL="${B2_UPDATE_CHECK_INTERVAL:-86400}"  # 24 hours
BD_INSTALL_URL="${B2_BD_INSTALL_URL:-https://raw.githubusercontent.com/steveyegge/beads/main/scripts/install.sh}"
BD_REPO="${B2_BD_REPO:-steveyegge/beads}"
DEFAULT_LABELS="${B2_DEFAULT_LABELS:-needs-project}"

# Paths
CONFIG_DIR="${HOME}/.config/b2"
CONFIG_FILE="${CONFIG_DIR}/config"
CACHE_DIR="${HOME}/.cache/b2"
UPDATE_CACHE="${CACHE_DIR}/last_update_check"

# Colors
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m'

# Logging functions
log_info() { echo -e "${BLUE}b2:${NC} $1" >&2; }
log_warn() { echo -e "${YELLOW}⚠️  $1${NC}" >&2; }
log_error() { echo -e "${RED}Error:${NC} $1" >&2; exit 1; }
log_success() { echo -e "${GREEN}✓${NC} $1" >&2; }

# Config loading
load_config() {
    # Load global config if exists
    if [[ -f "$CONFIG_FILE" ]]; then
        # shellcheck source=/dev/null
        source "$CONFIG_FILE"
    fi

    # Load per-repo config if exists
    if [[ -f ".b2rc" ]]; then
        # shellcheck source=/dev/null
        source ".b2rc"
    fi

    # Environment variables already override via ${VAR:-default} pattern
}
first_run_setup() {
    # Already initialized?
    [[ -f "$CONFIG_FILE" ]] && return 0

    # Detect cloud/agent environment (no TTY)
    local is_cloud=false
    [[ ! -t 0 ]] && is_cloud=true

    # Create directories
    mkdir -p "$CONFIG_DIR" "$BEADS_LOCATION" "$CACHE_DIR"

    # Create default config
    cat > "$CONFIG_FILE" <<EOF
# b2 configuration
# See: https://github.com/yourusername/dotfiles/blob/main/docs/plans/2025-12-21-b2-wrapper-design.md

BEADS_LOCATION="${BEADS_LOCATION}"
STEALTH_MODE=true
CHECK_UPDATES=true
UPDATE_CHECK_INTERVAL=86400
BD_INSTALL_URL="${BD_INSTALL_URL}"
BD_REPO="${BD_REPO}"
DEFAULT_LABELS="${DEFAULT_LABELS}"
EOF

    # Check for bd, install if missing
    if ! command -v bd &>/dev/null; then
        $is_cloud || log_info "bd not found, installing..."
        if command -v curl &>/dev/null; then
            curl -fsSL "$BD_INSTALL_URL" | bash
        else
            log_error "curl not found. Please install curl or bd manually."
        fi
    fi

    # Welcome message (unless cloud)
    if ! $is_cloud; then
        cat >&2 <<EOF

${GREEN}✓ b2 initialized successfully!${NC}
  Config: $CONFIG_FILE
  Beads:  $BEADS_LOCATION

Run 'b2 create "My first task"' to get started.

EOF
    fi
}
check_updates() {
    # Check cache age
    if [[ -f "$UPDATE_CACHE" ]]; then
        local cache_age=$(($(date +%s) - $(stat -f %m "$UPDATE_CACHE" 2>/dev/null || stat -c %Y "$UPDATE_CACHE" 2>/dev/null || echo 0)))
        [[ $cache_age -lt $UPDATE_CHECK_INTERVAL ]] && return 0
    fi

    # Get current version
    local current
    current=$(bd --version 2>/dev/null | awk '{print $3}' || echo "unknown")

    # Get latest version from GitHub API
    local latest
    if command -v curl &>/dev/null; then
        latest=$(curl -fsSL "https://api.github.com/repos/${BD_REPO}/releases/latest" 2>/dev/null | \
                 grep '"tag_name"' | sed -E 's/.*"tag_name": "([^"]+)".*/\1/' || echo "unknown")
    elif command -v wget &>/dev/null; then
        latest=$(wget -qO- "https://api.github.com/repos/${BD_REPO}/releases/latest" 2>/dev/null | \
                 grep '"tag_name"' | sed -E 's/.*"tag_name": "([^"]+)".*/\1/' || echo "unknown")
    else
        return 0  # Skip if no curl/wget
    fi

    # Strip 'v' prefix from latest
    latest="${latest#v}"

    # Update cache
    mkdir -p "$CACHE_DIR"
    echo "$(date +%s)|${current}|${latest}" > "$UPDATE_CACHE"

    # Compare versions (simple string comparison)
    if [[ "$current" != "unknown" ]] && [[ "$latest" != "unknown" ]] && [[ "$current" != "$latest" ]]; then
        log_warn "bd update available: ${current} → ${latest}"
        echo "  Run: curl -fsSL ${BD_INSTALL_URL} | bash" >&2
        echo "" >&2
    fi
}
get_project_prefix() {
    # Use the shared library
    local script_dir
    script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

    if [[ -x "${script_dir}/get-project-name" ]]; then
        "${script_dir}/get-project-name"
    elif command -v get-project-name &>/dev/null; then
        get-project-name
    else
        # Fallback: inline implementation
        if git rev-parse --git-dir &>/dev/null; then
            git remote get-url origin 2>/dev/null | \
                sed -E 's#.*/([^/]+)(\.git)?$#\1#' | \
                sed 's/\.git$//'
        fi
    fi
}
expand_hash() {
    local arg="$1"
    local project
    project=$(get_project_prefix)

    # Short hash: alphanumeric, no dash, 3-6 chars
    if [[ "$arg" =~ ^[a-z0-9]{3,6}$ ]] && [[ -n "$project" ]]; then
        echo "${project}-${arg}"
    else
        echo "$arg"  # Pass through unchanged
    fi
}

# Main entry point
main() {
    load_config
    first_run_setup
    [[ "$CHECK_UPDATES" == "true" ]] && check_updates

    # For now, just pass through to bd
    exec bd "$@"
}

main "$@"
