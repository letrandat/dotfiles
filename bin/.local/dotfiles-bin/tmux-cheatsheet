#!/usr/bin/env bash

# tmux-cheatsheet
# A fuzzy-searchable cheatsheet for tmux keybindings.
#
# Each entry has an action type visible in fzf:
#   [exec]  - Will execute the command on selection
#   [info]  - Will print the instruction on selection

set -e

# --- Dependency Check ---
if ! command -v fzf &> /dev/null; then
    echo "Error: fzf is not installed. Please install it first."
    exit 1
fi

# --- Detect Tmux Prefix ---
PREFIX=$(tmux show-option -g prefix 2>/dev/null | cut -d' ' -f2)
if [ -z "$PREFIX" ]; then
    PREFIX="C-b"
fi

# --- Key Binding Database ---
# Format: Category | Description | Keys | Action (exec/info)
get_keys() {
    cat <<EOF
Session | List sessions (outside tmux) | tmux ls | info
Session | Attach to session (outside tmux) | tmux attach -t <name> | info
Session | Create new session | tmux new -s <name> | info
Session | Detach from session | {prefix} d | info
Session | List sessions (in tmux) | {prefix} s | info
Session | Rename session | {prefix} $ | info
Window | Create new window | {prefix} t | info
Window | Close or kill current window | {prefix} w d | info
Window | Rename window | {prefix} R | info
Window | Search/switch windows | {prefix} a | info
Window | Previous window | {prefix} Left | info
Window | Next window | {prefix} Right | info
Pane | Split/New vertical (side-by-side) | {prefix} w v | info
Pane | Split/New horizontal (stacked) | {prefix} w s | info
Pane | Kill pane | {prefix} b d | info
Pane | Pick/choose panes (tree view) | {prefix} , | info
Zoom | Toggle zoom (current pane) | {prefix} z | info
Copy / Vim Mode | Enter copy mode | mouse scroll or {prefix} [ or page-up | info
Copy / Vim Mode | Begin selection | v (in copy mode) | info
Copy / Vim Mode | Copy to clipboard | y (in copy mode) | info
Copy / Vim Mode | Copy to end of line | Y (in copy mode) | info
Copy / Vim Mode | Search forward | / (in copy mode) | info
Copy / Vim Mode | Search backward | ? (in copy mode) | info
Copy / Vim Mode | Jump to top of screen | H (in copy mode) | info
Copy / Vim Mode | Jump to middle of screen | M (in copy mode) | info
Copy / Vim Mode | Jump to bottom of screen | L (in copy mode) | info
Misc | List keys | {prefix} ? | info
Misc | Reload config | {prefix} l | info
Misc | View config | cat ~/.tmux.conf | exec
Misc | Edit config | \$EDITOR ~/.tmux.conf | exec
Sessionizer | Switch/create session (fzf) | tmux-sessionizer | exec
Sessionizer | About: auto-attach on terminal spawn | tmux-autoattach.sh (vscode/ghostty) | info
Sessionizer | View sessionizer config | cat ~/.config/tmux-sessionizer/tmux-sessionizer.conf | exec
Sessionizer | Edit sessionizer config | \$EDITOR ~/.config/tmux-sessionizer/tmux-sessionizer.conf | exec
EOF
}

# --- Main ---
SELECTED=$(get_keys \
    | sed "s/{prefix}/$PREFIX/g" \
    | awk -F'|' '{
        # Trim whitespace and format with action tag
        gsub(/^[ \t]+|[ \t]+$/, "", $1)
        gsub(/^[ \t]+|[ \t]+$/, "", $2)
        gsub(/^[ \t]+|[ \t]+$/, "", $3)
        gsub(/^[ \t]+|[ \t]+$/, "", $4)
        printf "[%s] %-10s | %-30s | %s\n", $4, $1, $2, $3
    }' \
    | fzf --header="Tmux Cheatsheet (Prefix: $PREFIX)" \
          --reverse --height=40% --border)

if [ -n "$SELECTED" ]; then
    # Extract action type [exec] or [info]
    ACTION=$(echo "$SELECTED" | grep -o '^\[[a-z]*\]' | tr -d '[]')

    # Extract keys (last column after the last |)
    KEYS=$(echo "$SELECTED" | sed 's/.*| //')

    if [ "$ACTION" = "exec" ]; then
        echo "executing → $KEYS"
        eval "$KEYS"
    else
        echo "→ $KEYS"
    fi
fi
